(function(a,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("ol"),require("ol/proj"),require("ol/Observable.js"),require("ol/source/Vector"),require("ol/layer/Vector"),require("ol/geom"),require("cesium")):typeof define=="function"&&define.amd?define(["exports","ol","ol/proj","ol/Observable.js","ol/source/Vector","ol/layer/Vector","ol/geom","cesium"],h):(a=typeof globalThis<"u"?globalThis:a||self,h(a.Sync={},a.ol,a.ol.proj,a.ol.Observable,a.ol.source.Vector,a.ol.layer.Vector,a.ol.geom,a.Cesium))})(this,function(a,h,g,V,Dt,se,re,ae){var G,O,R,A,I,D,H,st,kt,rt,qt,at,zt,K,m,L,X,W,J,U,ot,xt,ct,Bt,lt,Ft,ht,Gt,Q,At,ut,It,dt,Kt,gt,Xt,Y,Ht,pt,Jt,ft,Qt,Z,_,mt,P,j,$,vt,Yt,tt,Lt,et,Wt,N,T,Mt,Zt,Ct,$t,k,bt,te,w,S,wt,ee,q,Pt,b,St,x,Et,ie,yt,ne;"use strict";var ve=Object.defineProperty;var Me=(a,h,g)=>h in a?ve(a,h,{enumerable:!0,configurable:!0,writable:!0,value:g}):a[h]=g;var F=(a,h,g)=>(Me(a,typeof h!="symbol"?h+"":h,g),g),Rt=(a,h,g)=>{if(!h.has(a))throw TypeError("Cannot "+g)};var n=(a,h,g)=>(Rt(a,h,"read from private field"),g?g.call(a):h.get(a)),r=(a,h,g)=>{if(h.has(a))throw TypeError("Cannot add the same private member more than once");h instanceof WeakSet?h.add(a):h.set(a,g)},l=(a,h,g,V)=>(Rt(a,h,"write to private field"),V?V.call(a,g):h.set(a,g),g),Nt=(a,h,g,V)=>({set _(Dt){l(a,h,Dt,g)},get _(){return n(a,h,V)}}),u=(a,h,g)=>(Rt(a,h,"access private method"),g);function oe(v){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(v){for(const e in v)if(e!=="default"){const i=Object.getOwnPropertyDescriptor(v,e);Object.defineProperty(t,e,i.get?i:{enumerable:!0,get:()=>v[e]})}}return t.default=v,Object.freeze(t)}const ce=oe(ae);function C(v){return v*180/Math.PI}function y(v){return v*Math.PI/180}function le(v){const t=90.7142857142857,e=1e3/25.4;return v*e*t}class he{constructor(t,e,i){r(this,st);r(this,rt);r(this,at);r(this,G,void 0);r(this,O,void 0);r(this,R,!1);r(this,A,null);F(this,"enable",!0);r(this,I,void 0);r(this,D,void 0);r(this,H,"EPSG:4326");F(this,"graphics",{add:({geometry:t,symbol:e})=>{console.log(t),console.log(e);let i=new h.Feature({geometry:new re.Polygon(t).transform(n(this,H),n(this,D)),symbol:e});const s=new Dt,o=new se({source:s,style:{"fill-color":"rgba(255, 255, 255, 0.2)","stroke-color":"#ffcc33","stroke-width":2,"circle-radius":7,"circle-fill-color":"#ffcc33"}});n(this,O).addLayer(o),s.addFeature(i)},remove:u(this,rt,qt),removeAll:u(this,at,zt)});l(this,G,e),l(this,O,t),l(this,I,i),l(this,A,t.getView().on("propertychange",()=>u(this,st,kt).call(this))),l(this,D,n(this,O).getView().getProjection())}get id(){return n(this,G)}get syncInfo(){const t=n(this,O).getView();if(!t)return;const e=t.getCenter();if(e==null)return;let i=t.getResolution()||1;const s=t.getProjection().getMetersPerUnit()??1;i=i*s;const o=g.transform(e,n(this,D),n(this,H)),c=C(t.getRotation());return{resolution:i,rotation:c,tilt:null,longitude:o[0],latitude:o[1]}}update(t){if(!t)return;l(this,R,!0);const e=n(this,O).getView();let i=e.getProjection().getMetersPerUnit()??1;const s=g.transform([t.longitude,t.latitude],n(this,H),n(this,D));e.setCenter(s);const o=t.resolution/i,c=e.getResolution()||1;Math.abs(o-c)/c>.01&&e.setResolution(o);const p=y(t.rotation);Math.abs(p-e.getRotation())>.01&&e.setRotation(p),l(this,R,!1)}destroy(){V.unByKey(n(this,A)),l(this,A,null)}}G=new WeakMap,O=new WeakMap,R=new WeakMap,A=new WeakMap,I=new WeakMap,D=new WeakMap,H=new WeakMap,st=new WeakSet,kt=function(){!this.enable||n(this,R)||n(this,I).call(this,this)},rt=new WeakSet,qt=function(t){console.log(t)},at=new WeakSet,zt=function(){};let d=window.Cesium||ce;class ue{constructor(t,e,i){r(this,ot);r(this,ct);r(this,lt);r(this,ht);r(this,Q);r(this,ut);r(this,dt);r(this,gt);r(this,Y);r(this,pt);r(this,ft);r(this,K,void 0);r(this,m,void 0);r(this,L,[]);F(this,"enable",!0);r(this,X,void 0);r(this,W,!1);r(this,J,void 0);r(this,U,0);l(this,K,e),l(this,m,t),l(this,J,i);let s=t.scene.preRender.addEventListener(()=>{n(this,W)&&u(this,Y,Ht).call(this)}),o=t.camera.moveStart.addEventListener(()=>{l(this,W,this.enable)}),c=t.camera.moveEnd.addEventListener(()=>{l(this,W,!1)});l(this,L,[s,o,c])}get id(){return n(this,K)}get syncInfo(){if(n(this,m).scene.mode===d.SceneMode.SCENE3D)return u(this,lt,Ft).call(this);if(n(this,m).scene.mode===d.SceneMode.SCENE2D)return u(this,ot,xt).call(this);if(n(this,m).scene.mode===d.SceneMode.COLUMBUS_VIEW)return u(this,ct,Bt).call(this)}update(t){if(t){switch(n(this,m).scene.mode){case d.SceneMode.SCENE3D:u(this,gt,Xt).call(this,t);break;case d.SceneMode.SCENE2D:u(this,ut,It).call(this,t);break;case d.SceneMode.COLUMBUS_VIEW:u(this,dt,Kt).call(this,t);break}u(this,Y,Ht).call(this,!0)}}destroy(){n(this,L).forEach(t=>{t()}),l(this,L,[])}}K=new WeakMap,m=new WeakMap,L=new WeakMap,X=new WeakMap,W=new WeakMap,J=new WeakMap,U=new WeakMap,ot=new WeakSet,xt=function(){const t=n(this,m).scene,e=t.canvas,i=t.camera.positionCartographic,s=(i==null?void 0:i.latitude)||0,o=(i==null?void 0:i.longitude)||0;return{resolution:i.height/e.clientWidth,rotation:0,tilt:0,longitude:C(o),latitude:C(s)}},ct=new WeakSet,Bt=function(){const t=n(this,m).scene,e=t.canvas,i=u(this,Q,At).call(this,t);let s;i?s=d.Cartographic.fromCartesian(i):s=t.camera.positionCartographic;let o=t.camera.positionCartographic.height;o=o/Math.sin(Math.abs(t.camera.pitch));const c=(s==null?void 0:s.latitude)||0,p=(s==null?void 0:s.longitude)||0,f=o/e.clientWidth,M=t.camera.pitch+d.Math.PI_OVER_TWO;return{resolution:f,rotation:-C(t.camera.heading),tilt:C(M),longitude:C(p),latitude:C(c)}},lt=new WeakSet,Ft=function(){const t=n(this,m).scene,e=d.Ellipsoid.WGS84,i=u(this,Q,At).call(this,t);let s,o,c=i;if(c){const Tt=t.camera.up,it=t.camera.right,Vt=new d.Cartesian3(-c.y,c.x,0),Ut=d.Cartesian3.angleBetween(it,Vt);s=d.Cartesian3.cross(c,Tt,new d.Cartesian3).z<0?Ut:-Ut;const me=t.camera.position,_t=new d.Cartesian3;e.geocentricSurfaceNormal(c,_t);const Ot=new d.Cartesian3;d.Cartesian3.subtract(me,c,Ot),d.Cartesian3.normalize(Ot,Ot);const jt=Math.acos(d.Cartesian3.dot(_t,Ot));o=isNaN(jt)?0:jt}else{const Tt=t.globe,it=t.camera.positionCartographic.clone(),Vt=Tt.getHeight(it);it.height=Vt||0,c=d.Ellipsoid.WGS84.cartographicToCartesian(it),s=t.camera.heading,o=t.camera.pitch+d.Math.PI_OVER_TWO}const p=d.Cartesian3.distance(c,t.camera.position),f=e.cartesianToCartographic(c),M=(f==null?void 0:f.latitude)||0,B=(f==null?void 0:f.longitude)||0,E=u(this,ft,Qt).call(this,p,M,t);return l(this,U,o),{resolution:E,rotation:C(s),tilt:C(o),longitude:C(B),latitude:C(M)}},ht=new WeakSet,Gt=function(t,e){const i=t.camera.getPickRay(e);return t.globe.pick(i,t)||t.camera.pickEllipsoid(e)},Q=new WeakSet,At=function(t){const e=t.canvas,i=new d.Cartesian2(e.clientWidth/2,e.clientHeight/2);return u(this,ht,Gt).call(this,t,i)},ut=new WeakSet,It=function(t){const e=n(this,m).scene,i=e.canvas,s=t.resolution*i.clientWidth;e.camera.setView({destination:d.Cartesian3.fromDegrees(t.longitude,t.latitude,s)})},dt=new WeakSet,Kt=function(t){const e=n(this,m).scene,i=e.canvas,s=t.tilt===null?e.camera.pitch:y(t.tilt-90);let o=Math.abs(s);const c=t.resolution*i.clientWidth/Math.sin(o),p=-y(t.rotation),f=d.Cartesian3.fromDegrees(t.longitude,t.latitude,c);e.camera.setView({destination:f,orientation:{heading:p,pitch:s,roll:void 0}}),e.camera.moveDown(c*Math.cos(o))},gt=new WeakSet,Xt=function(t){const e=n(this,m).scene,i=new d.Cartographic(y(t.longitude),y(t.latitude));if(e.globe){const M=e.globe.getHeight(i);i.height=M||0}const s=d.Ellipsoid.WGS84.cartographicToCartesian(i),o=-y(t.rotation),c=t.tilt===null?n(this,U)-d.Math.PI_OVER_TWO:y(t.tilt-90),p={pitch:c,heading:o,roll:void 0};e.camera.setView({destination:s,orientation:p});const f=u(this,pt,Jt).call(this,t.resolution,y(t.latitude),e);l(this,U,c+d.Math.PI_OVER_TWO),e.camera.moveBackward(f)},Y=new WeakSet,Ht=function(t=!1){const e=n(this,X),i=n(this,m).camera.viewMatrix;(!e||!d.Matrix4.equalsEpsilon(e,i,1e-5))&&(l(this,X,i.clone()),t!==!0&&n(this,J).call(this,this))},pt=new WeakSet,Jt=function(t,e,i){const s=i.canvas;let c=i.camera.frustum.fovy;console.assert(!isNaN(c));const p=t*s.clientHeight,f=Math.cos(Math.abs(e));return p*f/2/Math.tan(c/2)},ft=new WeakSet,Qt=function(t,e,i){const s=i.canvas;let c=i.camera.frustum.fovy||1;console.assert(!isNaN(c));const p=2*t*Math.tan(c/2),f=Math.cos(Math.abs(e));return p/f/s.clientHeight};class de{constructor(t,e,i){r(this,vt);r(this,tt);r(this,et);r(this,Z,void 0);r(this,_,void 0);r(this,mt,!1);r(this,P,null);r(this,j,null);F(this,"enable",!0);r(this,$,void 0);l(this,Z,e),l(this,_,t),l(this,$,i),l(this,j,t.watch("interacting,animation",s=>{!s||n(this,P)||l(this,P,t.watch("viewpoint",()=>{u(this,vt,Yt).call(this)}))}))}get id(){return n(this,Z)}get syncInfo(){const t=n(this,_);let e,i=null;u(this,tt,Lt).call(this,t)?(e=-t.camera.heading,i=t.camera.tilt):e=t.rotation;const s=t.center.longitude||0,o=t.center.latitude||0;return{resolution:t.resolution,rotation:e,tilt:i,longitude:s,latitude:o}}async update(t){if(!t)return;u(this,et,Wt).call(this);const e=n(this,_),i={type:"point",longitude:t.longitude,latitude:t.latitude};e.center=i,e.scale=le(t.resolution),u(this,tt,Lt).call(this,e)?(e.camera.heading=-t.rotation,e.camera.tilt=t.tilt??e.camera.tilt):e.rotation=t.rotation}destroy(){var t;u(this,et,Wt).call(this),(t=n(this,j))==null||t.remove(),l(this,j,null)}}Z=new WeakMap,_=new WeakMap,mt=new WeakMap,P=new WeakMap,j=new WeakMap,$=new WeakMap,vt=new WeakSet,Yt=function(){!this.enable||n(this,mt)||n(this,$).call(this,this)},tt=new WeakSet,Lt=function(t){return t.type==="3d"},et=new WeakSet,Wt=function(){var t;n(this,P)&&((t=n(this,P))==null||t.remove(),l(this,P,null))};const Ce="",ge=`<div class="error">\r
    <div class="info">\r
        <div>\r
            <p>软件未授权，请联系软件提供商，获取授权码！</p>\r
            <a href="">刷新</a>\r
        </div>\r
    </div>\r
</div>`,pe=`<div class="develop">\r
    开发预览版，有限期至【】@山维科技\r
</div>`,z=class{constructor(){r(this,Mt);r(this,Ct);r(this,bt);r(this,wt);r(this,q);r(this,T,"开发版");r(this,k,null);r(this,w,null);r(this,S,null);if(new.target===z)return n(z,N)||l(z,N,this),n(z,N)}get authtype(){return n(this,T)}get authorized(){return u(this,Ct,$t).call(this)}};let nt=z;N=new WeakMap,T=new WeakMap,Mt=new WeakSet,Zt=function(t,e){try{if(!t||t.length<8)return"";e||(e="sunway_webgis_auth_code"),e=encodeURIComponent(e);let i="";for(let E=0;E<e.length;E+=1)i+=e.charCodeAt(E).toString();let s=Math.floor(i.length/5),o=parseInt(i.charAt(s)+i.charAt(s*2)+i.charAt(s*3)+i.charAt(s*4)+i.charAt(s*5)),c=Math.round(e.length/2),p=Math.pow(2,31)-1,f=parseInt(t.substring(t.length-8,t.length),16);for(t=t.substring(0,t.length-8),i+=f;i.length>10;)i=(parseInt(i.substring(0,10))+parseInt(i.substring(10,i.length))).toString();i=(o*i+c)%p;let M="",B="";for(let E=0;E<t.length;E+=2)M=parseInt(t.substring(E,E+2),16)^Math.floor(i/p*255),B+=String.fromCharCode(M),i=(o*i+c)%p;return decodeURIComponent(B)}catch{return""}},Ct=new WeakSet,$t=function(){const t=u(this,Mt,Zt).call(this,window.licenses),e=t.split("|")[0],i=t.split("|")[1];l(this,T,t.split("|")[2]);let s=window.location.hostname.toUpperCase();if(s==="LOCALHOST"||s=="127.0.0.1")return!0;let o=!1;if(e.split(",").forEach(M=>{if(M.toUpperCase()===s){o=!0;return}}),!o)return u(this,q,Pt).call(this,"软件未授权，请联系软件提供商，获取授权码！"),!1;if(typeof i>"u")return u(this,q,Pt).call(this,"软件未授权，请联系软件提供商，获取授权码！"),!1;const p=u(this,bt,te).call(this),f=new Date(i);return p.getTime()>f.getTime()?(u(this,q,Pt).call(this,n(this,T)+"有限期至【"+i+"】已过期，请重新授权！@山维科技"),!1):(n(this,T)!="正式版"&&u(this,wt,ee).call(this,"开发预览版，有限期至【"+i+"】@山维科技"),!0)},k=new WeakMap,bt=new WeakSet,te=function(){if(!n(this,k)){const t=new window.XMLHttpRequest;t.open("GET","/",!1),t.send(null);const e=t.getResponseHeader("Date");l(this,k,new Date(e))}return n(this,k)},w=new WeakMap,S=new WeakMap,wt=new WeakSet,ee=function(t){n(this,S)||(l(this,S,document.createElement("div")),n(this,S).style.zIndex="999",n(this,S).classList.add("auth"),n(this,S).innerHTML=pe,document.body.appendChild(n(this,S)));const e=n(this,S).getElementsByClassName("develop")[0];e.innerHTML=t},q=new WeakSet,Pt=function(t){n(this,w)||(l(this,w,document.createElement("div")),n(this,w).style.zIndex="1000",n(this,w).classList.add("auth"),n(this,w).innerHTML=ge,document.body.appendChild(n(this,w)));const e=n(this,w).getElementsByTagName("p")[0];e.innerHTML=t},r(nt,N,void 0);class fe{constructor(t,e){r(this,Et);r(this,yt);r(this,b,[]);r(this,St,1);r(this,x,!1);F(this,"graphics",{add:t=>{n(this,b).forEach(e=>{var i;(i=e==null?void 0:e.graphics)==null||i.add(t)})},remove:t=>{n(this,b).forEach(e=>{var i;(i=e==null?void 0:e.graphics)==null||i.remove(t)})},removeAll:()=>{n(this,b).forEach(t=>{var e;(e=t==null?void 0:t.graphics)==null||e.removeAll()})}});new nt().authorized&&(this.enable=(e==null?void 0:e.enable)??!0,t.forEach(i=>{this.addMap(i)}))}set enable(t){n(this,x)!==t&&l(this,x,t)}get enable(){return n(this,x)}addMap(t){const e=u(this,yt,ne).call(this,t),i=Nt(this,St)._++,s=new e(t,i,u(this,Et,ie).bind(this));n(this,b).push(s)}removeMap(t){this.enable&&(t.enableSynchronizer=!1)}highlight(t){n(this,b).forEach(e=>{e==null||e.highlight(t)})}unhighlight(t){n(this,b).forEach(e=>{e==null||e.unhighlight(t)})}unHighlightAll(t){n(this,b).forEach(e=>{e==null||e.unhighlight(t)})}}b=new WeakMap,St=new WeakMap,x=new WeakMap,Et=new WeakSet,ie=function(t){if(!this.enable)return;const e=t.syncInfo;if(!e)return;n(this,b).filter(s=>s.id!==t.id).forEach(s=>{s==null||s.update(e)})},yt=new WeakSet,ne=function(t){var e;if(t.ol_uid)return he;if(t.cesiumWidget)return ue;if((e=t.map)!=null&&e.basemap)return de;throw new Error("cannot get map type")},a.Synchronizer=fe,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
